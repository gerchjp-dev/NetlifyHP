# ファビコン機能テストガイド

## 📋 テスト概要

このガイドでは、ブラウザタブ用ファビコン機能が正常に動作するかをテストする手順を説明します。

## 🎯 テスト対象機能

1. **データベース**: `browser_favicon_url` カラムの存在確認
2. **管理画面**: ファビコンのアップロード機能
3. **公開サイト**: ブラウザタブでのファビコン表示
4. **フォールバック**: デフォルトファビコンへの切り替え

## 🚀 事前準備

### 1. 開発環境の起動

```bash
cd /home/user/webapp
npm install  # 初回のみ
npm run dev
```

ブラウザで `http://localhost:5173` にアクセス

### 2. 管理者アカウントの確認

Supabase Dashboard → Authentication → Users で管理者アカウントが存在することを確認

### 3. ストレージバケットの確認

Supabase Dashboard → Storage → `company-images` バケットが存在することを確認

## ✅ テストケース

### テストケース1: データベーススキーマの確認

**目的:** `browser_favicon_url` カラムが正しく追加されているか確認

**手順:**

1. Supabase Dashboard → SQL Editor
2. 以下のSQLを実行:

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'company_info'
  AND column_name IN ('browser_favicon_url', 'favicon_url', 'hero_icon_url')
ORDER BY column_name;
```

**期待される結果:**

| column_name         | data_type | is_nullable |
|---------------------|-----------|-------------|
| browser_favicon_url | text      | YES         |
| favicon_url         | text      | YES         |
| hero_icon_url       | text      | YES         |

**判定:**
- ✅ **合格**: 3つのカラムすべてが表示される
- ❌ **不合格**: カラムが表示されない → マイグレーションを実行してください

---

### テストケース2: 管理画面へのログイン

**目的:** 管理画面にアクセスできるか確認

**手順:**

1. ブラウザで `http://localhost:5173/login` にアクセス
2. 管理者の認証情報（メールアドレスとパスワード）を入力
3. 「ログイン」ボタンをクリック

**期待される結果:**
- ログイン後、`/admin` ページにリダイレクトされる
- 管理画面のダッシュボードが表示される

**判定:**
- ✅ **合格**: 管理画面が表示される
- ❌ **不合格**: エラーが表示される → `.env` ファイルとSupabase設定を確認

---

### テストケース3: ファビコンアップロード機能

**目的:** 管理画面からファビコンをアップロードできるか確認

**手順:**

1. 管理画面で **「会社情報」** タブをクリック
2. 下にスクロールして **「ブラウザタブ用ファビコン」** セクションを表示
3. 「画像を選択」ボタンをクリック
4. テスト用の画像を選択（32×32px または 64×64px のPNG/ICO/SVG）
5. アップロードが完了するまで待機
6. 「保存」ボタンをクリック

**期待される結果:**
- アップロード中に「アップロード中...」と表示される
- アップロード完了後、画像のプレビューが表示される
- 保存後、「保存しました」というメッセージが表示される

**判定:**
- ✅ **合格**: 画像がアップロードされてプレビューが表示される
- ❌ **不合格**: エラーメッセージが表示される → ストレージバケットの設定を確認

---

### テストケース4: データベースへの保存確認

**目的:** アップロードしたファビコンURLがデータベースに保存されているか確認

**手順:**

1. Supabase Dashboard → SQL Editor
2. 以下のSQLを実行:

```sql
SELECT 
  id,
  company_name,
  browser_favicon_url,
  favicon_url,
  hero_icon_url
FROM company_info;
```

**期待される結果:**
- `browser_favicon_url` カラムに Supabase Storage の公開URLが保存されている
- URLの形式: `https://YOUR_PROJECT.supabase.co/storage/v1/object/public/company-images/browser_favicon-TIMESTAMP.png`

**判定:**
- ✅ **合格**: URLが保存されている
- ❌ **不合格**: NULLまたは空文字 → テストケース3を再実行

---

### テストケース5: ブラウザタブでのファビコン表示

**目的:** 公開サイトでカスタムファビコンが表示されるか確認

**手順:**

1. ブラウザで公開サイト（`http://localhost:5173/`）にアクセス
2. ブラウザのタブを確認
3. 開発者ツール（F12）を開く
4. Elements タブで `<head>` セクションを確認
5. `<link rel="icon">` タグを探す

**期待される結果:**
- ブラウザのタブにアップロードしたファビコンが表示される
- `<link rel="icon" href="https://...supabase.co/.../browser_favicon-....png">` のようなタグが存在する

**判定:**
- ✅ **合格**: カスタムファビコンが表示される
- ⚠️ **キャッシュの可能性**: デフォルトファビコンが表示される → 強制リロード（Ctrl+Shift+R）を実行

---

### テストケース6: ファビコンのフォールバック動作

**目的:** ファビコンが設定されていない場合にデフォルトファビコンが表示されるか確認

**手順:**

1. 管理画面で **「会社情報」** タブを開く
2. ブラウザタブ用ファビコンの **「削除」** ボタン（×アイコン）をクリック
3. 「保存」ボタンをクリック
4. 公開サイトにアクセスして強制リロード（Ctrl+Shift+R）

**期待される結果:**
- デフォルトのファビコン（`/sun-icon.svg`）が表示される
- または `favicon_url` に設定されている画像が表示される

**判定:**
- ✅ **合格**: デフォルトまたはフォールバックファビコンが表示される
- ❌ **不合格**: ファビコンが表示されない → `public/sun-icon.svg` が存在するか確認

---

### テストケース7: ストレージ画像への直接アクセス

**目的:** アップロードした画像に外部からアクセスできるか確認

**手順:**

1. テストケース4で取得した `browser_favicon_url` をコピー
2. 新しいブラウザタブを開く
3. URLをアドレスバーに貼り付けてアクセス

**期待される結果:**
- 画像が表示される
- HTTPステータス: 200 OK

**判定:**
- ✅ **合格**: 画像が表示される
- ❌ **不合格**: 403 Forbidden または 404 Not Found → ストレージのRLSポリシーを確認

---

### テストケース8: 複数ブラウザでの確認

**目的:** 異なるブラウザでも正しくファビコンが表示されるか確認

**手順:**

1. Chrome / Edge / Firefox / Safari のいずれかで公開サイトにアクセス
2. 各ブラウザでファビコンが表示されることを確認

**期待される結果:**
- すべてのブラウザでファビコンが表示される

**判定:**
- ✅ **合格**: すべてのブラウザで表示される
- ⚠️ **部分合格**: 一部のブラウザでのみ表示される → ファビコン形式を変更（PNG推奨）

---

## 🐛 トラブルシューティング

### ファビコンが表示されない

**解決策:**

1. **ブラウザキャッシュをクリア**
   - Chrome/Edge: Ctrl+Shift+Delete → 「キャッシュされた画像とファイル」を削除
   - Firefox: Ctrl+Shift+Delete → 「キャッシュ」を削除

2. **強制リロード**
   - Ctrl+Shift+R (Windows/Linux)
   - Cmd+Shift+R (Mac)

3. **シークレットモードで確認**
   - Ctrl+Shift+N (Chrome/Edge)
   - Ctrl+Shift+P (Firefox)

4. **開発者ツールで確認**
   - F12 → Network タブ → ファビコンのリクエストを確認
   - Console タブでエラーがないか確認

### アップロードエラー

**原因と解決策:**

| エラーメッセージ | 原因 | 解決策 |
|----------------|------|--------|
| "ファイルサイズが2MBを超えています" | ファイルサイズが大きすぎる | 画像を圧縮してください |
| "対応していない画像形式です" | 非対応の形式 | PNG, ICO, SVG形式に変換してください |
| "画像のアップロードに失敗しました" | ストレージの権限エラー | ストレージバケットのRLSポリシーを確認 |
| "保存に失敗しました" | データベースの権限エラー | テーブルのRLSポリシーを確認 |

### データベース接続エラー

**確認事項:**

1. `.env` ファイルが存在するか
   ```bash
   cat /home/user/webapp/.env
   ```

2. 環境変数が正しく設定されているか
   ```env
   VITE_SUPABASE_URL=https://YOUR_PROJECT_ID.supabase.co
   VITE_SUPABASE_ANON_KEY=YOUR_ANON_KEY
   ```

3. Supabaseプロジェクトが起動しているか
   - Supabase Dashboardでプロジェクトの状態を確認

## 📊 テスト結果記録シート

| テストケース | 結果 | 備考 |
|-------------|------|------|
| TC1: データベーススキーマ | ⬜ | |
| TC2: 管理画面ログイン | ⬜ | |
| TC3: ファビコンアップロード | ⬜ | |
| TC4: データベース保存 | ⬜ | |
| TC5: ブラウザ表示 | ⬜ | |
| TC6: フォールバック動作 | ⬜ | |
| TC7: ストレージアクセス | ⬜ | |
| TC8: 複数ブラウザ確認 | ⬜ | |

**判定:**
- ✅: 合格
- ❌: 不合格
- ⚠️: 条件付き合格

---

**最終更新日**: 2025年10月31日
**テスト環境**: Node.js 18+, React 18, Supabase
